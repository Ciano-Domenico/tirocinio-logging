input {
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    sincedb_path => "/tmp/sincedb_nginx"
    codec => "json"
    type => "nginx_access"
  }
}

filter {
  if [type] == "nginx_access" {
    mutate {
      add_field => { "service" => "nginx-proxy" }
      add_field => { "environment" => "tirocinio" }
    }

    if [status] {
      mutate {
        convert => { "status" => "integer" }
      }
    }

    if [body_bytes_sent] {
      mutate {
        convert => { "body_bytes_sent" => "integer" }
      }
    }

    if [request_time] {
      mutate {
        convert => { "request_time" => "float" }
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "tirocinio-nginx-%{+YYYY.MM.dd}"
  }

  stdout {
    codec => line {
      format => "[%{@timestamp}] %{status} %{request} - %{service}"
    }
  }
}
